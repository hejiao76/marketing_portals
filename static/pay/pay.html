<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
  <title>订单支付</title>
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />
  <script src="../jquery/1.11.1.js"></script>
  <script src="../jquery/cookie.js"></script>
  <!--<link rel="stylesheet" href="/static/css/app.css">-->
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/SecondKillpay.css">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_491957_72imm8oh2r3eg66r.css">
</head>
<style>
  html{ font-size: 100px; background: #F5F5F5; padding: .15rem; }
  .paybox {background: #F5F5F5; font-size: .14rem;}
  #app { background: #f5f5f5;}
  .paytop { background: #ffffff; position: relative; padding: .12rem; overflow: hidden;
    height:1.04rem;}
  .paytypebox { margin-top: .2rem; background: #ffffff;}
  .carimg {
    float: left;
    width:.8rem;
    height:.8rem;}
  .top_right { position: absolute;
    height:100%; left: 1.16rem;}
  .title { font-size: .14rem; color: #666666;}
  .paynumber { font-size: .16rem; margin-top: .08rem; color: #000000;}
  .paynumber>span { color: #ff0036;}
  .paylist { height: .5rem; line-height: .5rem;}
  .paylist:not(:last-child) { border-bottom: 1px solid #f1f1f1;}
  .paylist .iconleft { font-size: .3rem; color: #2AD800;  float: left; margin-right: .13rem; margin-left: .11rem;}
  .paylist .iconleft.icon-zhifubao {  color: #009EFB;}
  .iconright { color: #999999; font-size: .16rem; float: right; margin-right: .11rem;}

  .paybox.error .paytypebox .iconleft { color: #B7B7B7 !important;}

  .mesgbox { margin-top: .33rem; text-align: center; line-height: 1.8; display: none;}
  .mesgbox>div { color: #666666;}
  .errmesgbox { display: none;}
  .paybox.true .truemesg { display: block;}
  .paybox.error .errmesgbox { display: block;}

</style>
<body>
<div>
  <div class="loginbox">
    <div class="paybox true">
      <!-- error-->
      <div class="paytop">
        <img class="carimg" />
        <div class="top_right">
          <div class="title" id="title" >荣威RX5 万元抵扣券秒杀</div>
          <div class="paynumber">订单金额：<span style="color: #ff0036;" class="orderAmount">1.00元</span></div>
        </div>
      </div>
      <div id="showText"> </div>
      <div class="paytypebox ">
        <div id="wxpayButton" class="paylist">
          <span class="iconleft iconfont icon-weixin"></span>
          微信支付
          <span class="iconright iconfont icon-jiantou"></span>
        </div>
        <div id="alipayButton" class="paylist">
          <span class="iconleft iconfont icon-zhifubao"></span>
          支付宝支付
          <span class="iconright iconfont icon-jiantou"></span>
        </div>
      </div>
      <div class="mesgbox truemesg">
        <div>支付倒计时</div>
        <div>请您尽快支付，以免错失良机</div>
      </div>
      <div class="mesgbox errmesgbox">
        <div>很遗憾，本次秒杀已结束，您没有秒杀到该商品</div>
        <div>如已支付，请到 <span style="color: #ff0036;">我的秒杀</span> 中申请退款</div>
      </div>
    </div>
  </div>
</div>

<script>
  var baseURL= "http://ec.web.dev.chinameds.cn/activity/#/";
  $(function (){
    $.ajax({
      type:"GET",
      //http://webtest.familyku.com
      url:"http://localhost:8070/action/user/seckill/orderInfo",
      dataType:"json",
      data:{itemId:30,orderNum:'M0000000016'},
      success:function(data){
        $(".carimg").attr("src",data.result.imgUrl);
        $("#title").html(data.result.itemName)
        $(".orderAmount").html(data.result.orderAmount)
      },
      error:function(jqXHR){
        $("#data").html("发生错误:"+jqXHR.status);
      }
    });

      $.cookie("test",123,{"domain":"chinameds.cn"});
//      $.cookie("test",321);
//      alert("test-------->"+$.cookie("test"));
//      alert("cookie----->"+$.cookie("rwxtc"));
      $("#alipayButton").on("click",function (){
//          alert("alipay");
        aliPay();
      })
    $("#wxpayButton").on("click",function (){
          alert("wxPay");
          wxPay();
//      wxPay();
    })
  })
  /***
   * 解析URL
   * @param url
   * @param name
   */
  function getUrlParam (url, name) {
    var pattern = new RegExp("[?&]" + name + "=([^&^#]+)", "g");
    var matcher = pattern.exec(url);
    var items = null;
    if (null != matcher) {
      try {
        items = decodeURIComponent(decodeURIComponent(matcher[1]));
      } catch (e) {
        try {
          items = decodeURIComponent(matcher[1]);
        } catch (e) {
          items = matcher[1];
        }
      }
    }
    return items;
  }
  /**
   * 判断浏览器是否是微信浏览器
   * @returns {boolean}
   */
  function isWeiXin(){
    var ua = window.navigator.userAgent.toLowerCase();
    if(ua.match(/MicroMessenger/i) == 'micromessenger'){
      return true;
    }else{
      return false;
    }
  }
  function aliPay (){
    var orderNum=getUrlParam(window.location.href,"orderNum");
    var itemId=getUrlParam(window.location.href,"itemId");
    if(!orderNum || !itemId){
        return;
    }
    // 创建一个 form
    var form1 = document.createElement("form");
    form1.id = "form1";
    form1.name = "form1";
    // 添加到 body 中
    document.body.appendChild(form1);
    // 创建一个输入
    var input1 = document.createElement("input");
    // 设置相应参数
    input1.type = "text";
    input1.name = "itemId";
    input1.value = itemId;

    // 创建一个输入
    var input2 = document.createElement("input");
    // 设置相应参数
    input2.type = "text";
    input2.name = "clientType";
    input2.value = "1";

    // 创建一个输入
    var input3 = document.createElement("input");
    // 设置相应参数
    input3.type = "text";
    input3.name = "orderNum";
    input3.value = orderNum;

    // 将该输入框插入到 form 中111111111111111111111111111111111111
    form1.appendChild(input1);
    form1.appendChild(input2);
    form1.appendChild(input3);
    // form 的提交方式
    form1.method = "POST";
    // form 提交路径
    form1.action = "/action/user/seckill/aliPay";
    // 对该 form 执行提交
    form1.submit();
    // 删除该 form
    document.body.removeChild(form1);
  }
  function wxPay() {
    var orderNum = getUrlParam(window.location.href, "orderNum");
    var itemId = getUrlParam(window.location.href, "itemId");
    var openId = $.cookie("rwxtc");
    alert("orderNun=" + orderNum + "~~~itemID=" + itemId + "~~~~openId=" + openId);
    if (!orderNum || !itemId || !openId) {return }
      var param = {orderNum: orderNum, itemId: itemId, openId: openId,clientType:1};
      alert(JSON.stringify(param));
      $.ajax({
        type: 'POST',
        dataType: "JSON",
        url: "/action/user/seckill/weixinPay",
        data: param,
        success: function (res) {
          if (res.status == true) {
            if (res.code == 200) {
              if (typeof WeixinJSBridge == "undefined") {
                if (document.addEventListener) {
                  document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                } else if (document.attachEvent) {
                  document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                  document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                }
              } else {
                var param = {
                  appId: res.result.appId,
                  timeStamp: res.result.timeStamp,
                  nonceStr: res.result.nonceStr,
                  package:res.result.paySubmitContent,
                  signType: "MD5",
                  paySign: res.result.sign
                }
                alert("wxBridge--------->" + JSON.stringify(param));
                $("#showText").html(JSON.stringify(param));
                onBridgeReady(param);
              }
            } else if (res.code == 3) {
              console.log("未报名");
            } else if (res.code == 999) {
              console.log("未登录");
            } else if (res.code == 4) {
              console.log("已支付");
            }
          } else {
            console.log("秒杀异常---" + res.message);
          }
        }
      });

  }

    function onBridgeReady(param){
      WeixinJSBridge.invoke(
        'getBrandWCPayRequest', param,
        function(res){
          if(res.err_msg == "get_brand_wcpay_request:ok" ) {
              var itemId = getUrlParam(window.location.href, "itemId");
              alert("这里成功回调------>"+itemId);
              window.location.href=baseURL+"sedKill/secondcardetail?id="+itemId;
          }     // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。
          else{
              alert("支付失败");
              window.location.href=baseURL+"mysedKill/secondlist";
          }
        }
      );
    }


//    if(!orderNum || !itemId || !openId){
//      return;
//    }
//    // 创建一个 form
//    var form2 = document.createElement("form");
//    form2.id = "form2";
//    form2.name = "form2";
//    // 添加到 body 中
//    document.body.appendChild(form2);
//    // 创建一个输入
//    var input1 = document.createElement("input");
//    // 设置相应参数
//    input1.type = "text";
//    input1.name = "itemId";
//    input1.value = itemId;
//
//    // 创建一个输入
//    var input2 = document.createElement("input");
//    // 设置相应参数
//    input2.type = "text";
//    input2.name = "clientType";
//    input2.value = "1";
//
//    // 创建一个输入
//    var input3 = document.createElement("input");
//    // 设置相应参数
//    input3.type = "text";
//    input3.name = "orderNum";
//    input3.value = orderNum;
//    alert(orderNum);
//
//    // 创建一个输入
//    var input4 = document.createElement("input");
//    // 设置相应参数
//    input4.type = "text";
//    input4.name = "openId";
//    input4.value = openId;
//
//    // 将该输入框插入到 form
//    form2.appendChild(input1);
//    form2.appendChild(input2);
//    form2.appendChild(input3);
//    // form 的提交方式
//    form2.method = "POST";
//    // form 提交路径
//    form2.action = "/action/user/seckill/weixinPay";
//    // 对该 form 执行提交
//    form2.submit();
//    // 删除该 form
//    document.body.removeChild(form2);

</script>
</body>
</html>
